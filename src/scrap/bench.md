---
title: ベンチでは幾何平均を使え(?)
date: 2023-03-22
tag :
    - scrap
---

# ベンチでは幾何平均を使え(?)
タネ論文 : [HOW NOT TO LIE WITH STATISTICS: THE CORRECT WAY TO SUMMARIZE BENCHMARK RESULTS](https://dl.acm.org/doi/pdf/10.1145/5666.5673)

## 問題
次の表は検体 A～E に対するアルゴリズム (手法) 1～3 の実行時間である。
各手法の性能差はどう評価すればよいだろうか？

| 検体 | 手法1 | 手法2 | 手法3 |
|:----:|------:|------:|------:|
|   A  |   417 |   244 |   134 |
|   B  |    83 |    70 |    70 |
|   C  |    66 |   153 |   135 |
|   D  | 39449 | 33527 | 66000 |
|   E  |   772 |   368 |   369 |

ここでは2つの手法を比べる。
- 各ケースについて正規化したのち、算術平均をとる。
- 各ケースについて正規化したのち、幾何平均をとる。

## 先に結論
**結論 : 幾何平均を使え。**

**Q. なぜ性能測定で幾何平均を使うのか？**<br>
A. 幾何平均はどの比較対象を基準にするかで結果が変わらないから。

**Q. 算術平均ではだめか？**<br>
A. どの比較対象を基準に正規化するかで結果が変わるからダメ。

**Q. 正規化なんかせずに、生の値の総和で性能比較すればよいのでは？ (本稿では省略)**<br>
A. それでも良い。各検体に重みをつけたい場合は、生データに重みを掛けた上で和をとればよい。

## 実際に試してみる
先ほどの例について、正規化の基準を変えつつ算術平均と幾何平均を比べてみる。

### 状況1 : 手法1 を基準に正規化する
手法1を基準に各列を正規化する場合、結果は次のようになる。

| 検体      | 手法1 | 手法2 | 手法3 |
|:---------:|------:|------:|------:|
|  B        |  1.00 |  0.84 |  0.85 |
|  A        |  1.00 |  0.59 |  0.32 |
|  C        |  1.00 |  2.32 |  2.05 |
|  D        |  1.00 |  0.85 |  1.67 |
|  E        |  1.00 |  0.48 |  0.45 |
| 算術平均  |  1.00 |  1.01 |  1.07 |
| 幾何平均  |  1.00 |  0.86 |  0.84 |

### 状況2 : 手法2 を基準に正規化する
手法2を基準に各列を正規化する場合、結果は次のようになる。

| 検体     | 手法1 | 手法2 | 手法3 |
|:--------:|------:|------:|------:|
|   A      |  1.71 |  1.00 |  0.55 |
|   B      |  1.19 |  1.00 |  1.00 |
|   C      |  0.43 |  1.00 |  0.88 |
|   D      |  1.18 |  1.00 |  1.97 |
|   E      |  2.10 |  1.00 |  1.00 |
| 算術平均 |  1.32 |  1.00 |  1.08 |
| 幾何平均 |  1.17 |  1.00 |  0.99 |

### 状況1, 2 を比べる
**算術平均 : 状況1と2で各手法の性能の比率も順序も変わっている。**
- 状況1では手法2は手法1の1.01倍。状況2では0.76倍。

**幾何平均 : 状況1と2で各手法の性能の比率も順序も変わっていない。**
- 状況1でも2でも、手法2は手法1の0.86倍。

したがって、幾何平均のほうが良い性質を持っていそうである。

## 数学的証明
(論文の説明は複雑に感じたので条件を変えているが、おそらくは論文の主張と同値。)

検体 $c_1, \cdots c_n$ について、様々な手法で実験したとする。

| 検体     | 手法A    | 手法B    | $\cdots$ | 手法X    | 手法Y    |
|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|
| $c_1$    | $a_1$    | $b_1$    | $\cdots$ | $x_1$    | $y_1$    |
| $\vdots$ | $\vdots$ | $\vdots$ | $\vdots$ | $\vdots$ | $\vdots$ |
| $c_i$    | $a_i$    | $b_i$    | $\cdots$ | $x_i$    | $y_i$    |
| $\vdots$ | $\vdots$ | $\vdots$ | $\vdots$ | $\vdots$ | $\vdots$ |
| $c_n$    | $a_n$    | $b_n$    | $\cdots$ | $x_n$    | $y_n$    |

このうち X, Y について A を基準に正規化し、ある関数 $f$ で X と Y の性能を算出する。

| 検体     | 手法X    | 手法Y    |
|:--------:|:--------:|:--------:|
| $c_1$    | $x_1/a_1$| $y_1/a_1$|
| $\vdots$ | $\vdots$ | $\vdots$ |
| $c_i$    | $x_i/a_i$| $y_i/a_i$|
| $\vdots$ | $\vdots$ | $\vdots$ |
| $c_n$    | $x_n/a_n$| $y_n/a_n$|
| 性能     | $f(x_1/a_1,\cdots,x_n/a_n)$| $f(y_1/a_1,\cdots,y_n/a_n)$|

この時 X と比べた時の Y の性能は次であらわされる。
$$
\dfrac{f(x_1/a_1,\cdots,x_n/a_n)}{f(y_1/a_1,\cdots,y_n/a_n)}
$$

同様に、B を基準に正規化した場合は次のようになる。
$$
\dfrac{f(x_1/b_1,\cdots,x_n/b_n)}{f(y_1/b_1,\cdots,y_n/b_n)}
$$

これら二つの値が (A, B, X, Y の選び方によらず) 同じになるのが理想である。

つまり $f$ は次を満たすべきである。
- (性質1) $\forall A, B, X, Y \in \mathbb{R}^{+n} \ \ \dfrac{f(x_1/a_1,\cdots,x_n/a_n)}{f(y_1/a_1,\cdots,y_n/a_n)} = \dfrac{f(x_1/b_1,\cdots,x_n/b_n)}{f(y_1/b_1,\cdots,y_n/b_n)}$

また平均的な性能を表す関数として、次の2条件も満たしてほしい。
- (性質2) $f(a, \cdots, a) = a$
- (性質3) $f(a_1, \cdots, a_n) = f(a_{\sigma{(1)}}, \cdots a_{\sigma{(n)}})$

(ただし $\sigma$ は任意の順列)


### 主張
これら3条件を満たすのは幾何平均だけである。

### 証明
幾何平均がこれら条件を満たすのは簡単に示せる。<br>
あとは逆を示せばよい。

(性質1) について $B = Y$ のとき次が成り立つ。
$$
\begin{align*}
    \dfrac{f(x_1/a_1,\cdots,x_n/a_n)}{f(y_1/a_1,\cdots,y_n/a_n)}
        &= \dfrac{f(x_1/y_1,\cdots,x_n/y_n)}{f(1,\cdots,1)} \\
        &= f(x_1/y_1,\cdots,x_n/y_n) \ \ \because \text{(性質2)}\\
\end{align*}
$$

$s_i = x_i/y_i$, $t_i = y_1/a_i$ と置くと、
$$
\begin{align*}
    \dfrac{f(s_1t_1,\cdots,\alpha_nt_n)}{f(t_1,\cdots,t_n)} &= f(\alpha_1,\cdots,\alpha_n) \\
    f(s_1t_1,\cdots,\alpha_nt_n) &= f(\alpha_1,\cdots,\alpha_n) f(t_1,\cdots,t_n)\\
\end{align*}
$$

したがって、関数 $f$ は次を満たす。
- (性質1') $\forall S, T \in \mathbb{R}^{+n} f(s_1t_1,\cdots,\alpha_nt_n) = f(\alpha_1,\cdots,\alpha_n) f(t_1,\cdots,t_n)$

適当な数 $r$ について (性質1'), (性質2), (性質3) より次が成り立つ。
$$
\begin{align*}
    r &= f(r, \cdots, r) \\
      &= f(r, 1, \cdots, 1) f(1, r, 1, \cdots, 1) \cdots f(1, \cdots, 1, r) \\
      &= f(r, 1, \cdots, 1) f(r, 1, \cdots, 1) \cdots f(r, 1, \cdots, 1) \\
      &= f(r, 1, \cdots, 1)^n \\
    r^{1/n} &= f(r, 1, \cdots, 1)
\end{align*}
$$

これと (性質1'), (性質3) より次が成り立つ。
$$
\begin{align*}
    f(a_1, \cdots, a_n)
        &= f(a_1, 1, \cdots, 1) f(1, a_2, 1, \cdots, 1) \cdots f(1, \cdots, 1, a_n) \\
        &= f(a_1, 1, \cdots, 1) f(a_2, 1, \cdots, 1) \cdots f(a_n, 1, \cdots, 1) \\
        &= (a_1 \cdots a_n)^{1/n}
\end{align*}
$$

これは幾何平均である。

以上より、順方向も逆方向も示せたので、上記3条件を満たすのは幾何平均だけであることが示された。

## 感想
確かに幾何平均をとれば、正規化の基準を変えても評価は変わらない。
これは扱いやすい性質である。
しかし、果たしてこれはアルゴリズムの性能を正確に示しているのだろうか？

そうは言い切れないと思う。<br>
例えばこういう極端なケースを考えてみる。

| 検体 | 手法1 | 手法2 | 手法3 |
|:----:|------:|------:|------:|
|  A   |     2 |     4 |     1 |
|  B   | 20000 | 10000 | 40000 |


これを正規化して幾何平均をとると、どれも同じ性能ということになる。

|   検体   | 手法1 | 手法2 | 手法3 |
|:--------:|------:|------:|------:|
|    A     |  1.00 |  2.00 |  0.50 |
|    B     |  1.00 |  0.50 |  2.00 |
| 幾何平均 |  1.00 |  1.00 |  1.00 |


しかし実用上、手法1と手法2が同じ性能になりそうなのはAとBの利用頻度が 5000 : 1 の時であるし、手法2と手法3が同じ性能になりそうなのはAとBの利用頻度が 10000 : 1 の時である。

ある人は、生データの和では実行時間の長いプログラムの重みが大きくなってしまうから正規化した値の幾何平均をとった方が良いのだと言っていた。
はたして、そんなことを勝手にしていいのだろうか。分からない。
